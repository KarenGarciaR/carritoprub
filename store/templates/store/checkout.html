{% extends 'store/main.html' %}
{% load static %}
{% block content %}

<div class="row">
	<div class="col-lg-6">
		<div class="box-element" id="form-wrapper">
            <div class="card-header bg-primary text-white mb-4 rounded">
                <h5 class="mb-0"><i class="bi bi-truck"></i> Informaci√≥n de Env√≠o</h5>
                <small><i class="bi bi-gift"></i> Env√≠o gratuito en toda la rep√∫blica</small>
            </div>
            
            {% csrf_token %}
            <form id="form">
                <!-- Informaci√≥n Personal -->
                <div id="user-info">
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-person-circle"></i> Datos del Cliente
                            </h6>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label fw-bold">
                                <i class="bi bi-person"></i> Nombre Completo *
                            </label>
                            <input required class="form-control" type="text" id="name" name="name" 
                                   placeholder="Ej: Juan P√©rez Garc√≠a"
                                   value="{% if customer %}{{ customer.name }}{% endif %}">
                            <div class="form-text">Nombre como aparece en tu identificaci√≥n</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label fw-bold">
                                <i class="bi bi-envelope"></i> Correo Electr√≥nico *
                            </label>
                            <input required class="form-control" type="email" id="email" name="email" 
                                   placeholder="correo@ejemplo.com"
                                   value="{% if customer %}{{ customer.email }}{% endif %}">
                            <div class="form-text">Para notificaciones del pedido</div>
                        </div>
                    </div>
                </div>
                
                <!-- Informaci√≥n de Env√≠o -->
                <div id="shipping-info">
                    <hr class="my-4">
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-geo-alt"></i> Direcci√≥n de Entrega
                            </h6>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cellphone" class="form-label fw-bold">
                                <i class="bi bi-telephone"></i> Tel√©fono de Contacto *
                            </label>
                            <input required class="form-control" type="tel" id="cellphone" name="cellphone" 
                                   placeholder="Ej: 981 123 4567"
                                   value="{% if customer %}{{ customer.phone_number }}{% endif %}">
                            <div class="form-text">Para coordinar la entrega</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="zipcode" class="form-label fw-bold">
                                <i class="bi bi-mailbox"></i> C√≥digo Postal *
                            </label>
                            <input required class="form-control" type="text" id="zipcode" name="zipcode" 
                                   placeholder="Ej: 24000"
                                   pattern="[0-9]{5}"
                                   maxlength="5"
                                   value="{% if customer %}{{ customer.zip_code }}{% endif %}">
                            <div class="form-text">5 d√≠gitos num√©ricos</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="address" class="form-label fw-bold">
                                <i class="bi bi-house-door"></i> Direcci√≥n Completa *
                            </label>
                            <input required class="form-control" type="text" id="address" name="address" 
                                   placeholder="Ej: Calle 5 de Mayo #123, Colonia Centro"
                                   value="{% if customer %}{{ customer.address }}{% endif %}">
                            <div class="form-text">Calle, n√∫mero, colonia o fraccionamiento</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="city" class="form-label fw-bold">
                                <i class="bi bi-building"></i> Ciudad *
                            </label>
                            <input required class="form-control" type="text" id="city" name="city" 
                                   placeholder="Ej: Campeche"
                                   value="{% if customer %}{{ customer.municipality }}{% endif %}">
                            <div class="form-text">Ciudad donde vives</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="state" class="form-label fw-bold">
                                <i class="bi bi-map"></i> Estado/Municipio *
                            </label>
                            <input required class="form-control" type="text" id="state" name="state" 
                                   placeholder="Ej: Campeche"
                                   value="{% if customer %}{{ customer.state }}{% endif %}">
                            <div class="form-text">Estado o municipio</div>
                        </div>
                    </div>
                    
                    <!-- Referencias adicionales -->
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="referencias" class="form-label fw-bold">
                                <i class="bi bi-signpost"></i> Referencias de Ubicaci√≥n (Opcional)
                            </label>
                            <textarea class="form-control" id="referencias" name="referencias" rows="2"
                                      placeholder="Ej: Entre las calles Hidalgo y Morelos, casa de color azul, port√≥n caf√©"></textarea>
                            <div class="form-text">Ay√∫danos a encontrar tu direcci√≥n m√°s f√°cilmente</div>
                        </div>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <!-- Bot√≥n de continuar -->
                <div class="d-grid">
                    <button id="form-button" class="btn btn-danger btn-lg rounded-pill" type="submit"
                            style="background-color: #e9820d; color: white;"
                            onmouseover="this.style.backgroundColor='#A03A3A';"
                            onmouseout="this.style.backgroundColor='#CB4C4C';">
                        <i class="bi bi-arrow-right-circle"></i> Continuar al Pago
                    </button>
                </div>
            </form>
		</div>
        <br>
        <div class="box-element hidden" id="payment-info">
            <div class="card-header bg-success text-white mb-4 rounded">
                <h5 class="mb-0"><i class="bi bi-credit-card"></i> M√©todo de Pago</h5>
                <small>Selecciona c√≥mo prefieres pagar tu pedido</small>
            </div>
            
            <!-- Pago directo -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-cash-coin text-success me-2 fs-4"></i>
                        <div>
                            <h6 class="mb-0">Pago Directo</h6>
                            <small class="text-muted">Transferencia bancaria o efectivo</small>
                        </div>
                    </div>
                    <p class="text-muted small mb-3">
                        Puedes pagar mediante transferencia bancaria o efectivo contra entrega. 
                        Te enviaremos los datos bancarios por correo.
                    </p>
                    <button id="make-payment" class="btn btn-success w-100 rounded-pill">
                        <i class="bi bi-check-circle"></i> Finalizar Pedido - Pago Directo
                    </button>
                </div>
            </div>
        
            <!-- Separador -->
            <div class="text-center my-3">
                <span class="badge bg-secondary">O</span>
            </div>
            
            <!-- PayPal -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                        <i class="bi bi-paypal text-primary me-2 fs-4"></i>
                        <div>
                            <h6 class="mb-0">PayPal</h6>
                            <small class="text-muted">Pago seguro con PayPal</small>
                        </div>
                    </div>
                    <p class="text-muted small mb-3">
                        Paga de forma segura con tu cuenta PayPal o tarjeta de cr√©dito/d√©bito.
                    </p>
                    <div id="paypal-button" class="mt-2"></div>
                </div>
            </div>
        </div>        
	</div>

	<div class="col-lg-6">
        <div class="box-element">
            <hr>
            <h3>Resumen del pedido</h3>
            <hr>
            {% for item in items %}
            <div class="cart-row">
                <div style="flex:2"><img class="row-image" src="{{item.product.imageURL}}"></div>
                <div style="flex:2"><p>{{item.product.name}}</p></div>
                <div style="flex:1"><p>${{item.product.price|floatformat:2}}</p></div>
                <div style="flex:1"><p>x{{item.quantity}}</p></div>
            </div>
            {% endfor %}
            <h5>Items: {{order.get_cart_items}}</h5>
            <h5>Total: ${{order.get_cart_total|floatformat:2}}</h5>
        </div>
	</div>
</div>

<script src="https://www.paypalobjects.com/api/checkout.js"></script>

<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        var shipping = "{{ order.shipping|escapejs }}";
        var total = "{{ order.get_cart_total|floatformat:2 }}";
        var user = "{{ request.user|escapejs }}";
        var orderHistoryUrl = "{% url 'order_history' %}";
        var csrftoken = getCookie('csrftoken');

        var form = document.getElementById('form');

        form.addEventListener('submit', function(e){
            e.preventDefault();
            console.log('Form Submitted...');
            document.getElementById('form-button').classList.add('hidden');
            document.getElementById('payment-info').classList.remove('hidden');
        });

        document.getElementById('make-payment').addEventListener('click', function(e){
            processOrder();
        });

        paypal.Button.render({
            env: 'sandbox',
            client: {
                sandbox: 'demo_sandbox_client_id',  // Reemplaza con tu client_id real
                production: 'demo_production_client_id'
            },
            locale: 'en_MX',
            style: {
                size: 'small',
                color: 'gold',
                shape: 'pill',
            },
            commit: true,
            payment: function(data, actions) {
                return actions.payment.create({
                    transactions: [{
                        amount: {
                            total: total,
                            currency: 'MXN'
                        }
                    }]
                });
            },
            onAuthorize: function(data, actions) {
                return actions.payment.execute().then(function() {
                    console.log("Pago autorizado por PayPal");
                    processOrder();
                });
            }
        }, '#paypal-button');

        function processOrder() {
            console.log('Iniciando procesamiento de la orden...');

            var userFormData = {
                'name': form.name.value,
                'email': form.email.value,
                'total': total
            };

            var shippingInfo = {
                'cellphone': form.cellphone.value,
                'address': form.address.value,
                'city': form.city.value,
                'state': form.state.value,
                'zipcode': form.zipcode.value,
                'referencias': form.referencias ? form.referencias.value : ''
            };

            if (shipping !== 'False') {
                // Validaciones m√°s espec√≠ficas
                if (!form.name.value.trim()) {
                    alert("‚ùå Por favor ingresa tu nombre completo.");
                    return;
                }
                if (!form.email.value.trim()) {
                    alert("‚ùå Por favor ingresa tu correo electr√≥nico.");
                    return;
                }
                if (!form.cellphone.value.trim()) {
                    alert("üìû Por favor ingresa tu n√∫mero de tel√©fono para coordinar la entrega.");
                    return;
                }
                if (!form.address.value.trim()) {
                    alert("üè† Por favor ingresa tu direcci√≥n completa (calle, n√∫mero, colonia).");
                    return;
                }
                if (!form.city.value.trim()) {
                    alert("üèôÔ∏è Por favor ingresa tu ciudad.");
                    return;
                }
                if (!form.state.value.trim()) {
                    alert("üó∫Ô∏è Por favor ingresa tu estado o municipio.");
                    return;
                }
                if (!form.zipcode.value.trim()) {
                    alert("üìÆ Por favor ingresa tu c√≥digo postal.");
                    return;
                }
                
                // Validaci√≥n del c√≥digo postal (5 d√≠gitos)
                if (!/^\d{5}$/.test(form.zipcode.value.trim())) {
                    alert("üìÆ El c√≥digo postal debe tener exactamente 5 d√≠gitos num√©ricos.");
                    return;
                }
            }

            console.log('Enviando Shipping Info:', shippingInfo);
            console.log('Enviando User Info:', userFormData);

            var url = '/process_order/';
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({'form': userFormData, 'shipping': shippingInfo})
            })
            .then((response) => response.json())
            .then((data) => {
                console.log('Orden procesada exitosamente:', data);
                alert('¬°Transacci√≥n completada!');

                var cart = {};
                document.cookie = 'cart=' + JSON.stringify(cart) + ';domain=;path=/';
                window.location.href = orderHistoryUrl;
            })
            .catch((error) => {
                console.error('Error al procesar la orden:', error);
                alert("Hubo un problema al procesar la orden.");
            });
        }

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>

{% endblock content %}

<style>
    /* Estilos para mejorar el formulario de checkout */
    .form-label {
        color: #2c3e50;
        font-weight: 600;
    }
    
    .form-control:focus {
        border-color: #e9820d;
        box-shadow: 0 0 0 0.2rem rgba(233, 130, 13, 0.25);
    }
    
    .form-text {
        color: #6c757d;
        font-size: 0.875em;
    }
    
    .card-header {
        border: none !important;
    }
    
    .box-element {
        padding: 1.5rem;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        background-color: #fff;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    /* Iconos en labels */
    .form-label i {
        color: #e9820d;
        margin-right: 0.25rem;
    }
    
    /* Estilos para secci√≥n de pago */
    #payment-info .card {
        border: 1px solid #dee2e6;
        transition: all 0.3s ease;
    }
    
    #payment-info .card:hover {
        border-color: #e9820d;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    /* Validaci√≥n visual */
    .form-control:invalid {
        border-color: #dc3545;
    }
    
    .form-control:valid {
        border-color: #28a745;
    }
    
    /* Responsive improvements */
    @media (max-width: 768px) {
        .box-element {
            padding: 1rem;
        }
        
        .card-header h5 {
            font-size: 1.1rem;
        }
    }
</style>